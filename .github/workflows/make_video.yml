name: Run the workflow
on:
  push:
    branches:
      - '**'

jobs:
  build-video:
    # ✅ Only run if the actor is the repo owner
    if: github.actor == github.repository_owner
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout code
        uses: actions/checkout@v3

      - name: ⛔ Skip if commit message is not 'Add files via upload'
        id: check_message
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          if [[ "$COMMIT_MSG" != Add\ files\ via\ upload* ]]; then
            echo "Skipping workflow. Commit message does not match."
            exit 78
          fi

      - name: 🔍 Extract duration based on branch name
        id: duration
        run: |
          BRANCH_NAME="${GITHUB_REF##*/}"
          echo "Branch name: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" == *-01 ]]; then
            echo "duration=3600" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" == *-04 ]]; then
            echo "duration=14400" >> $GITHUB_OUTPUT
          else
            echo "duration=3600" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: ⚙️ Set up FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: 🛠️ Run Bash video script
        run: bash scripts/make_video.sh "${{ steps.duration.outputs.duration }}"

      - name: 📦 Upload final video as artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-relaxing-video
          path: "*.mp4"
