name: RMB Long

on:
  push:
    paths:
      - 'assets/*.mp4'
      - 'assets/*.jpeg'
      - 'assets/*.wav'
  workflow_dispatch:

jobs:
  check-conditions:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.params.outputs.should_run }}
      duration: ${{ steps.params.outputs.duration }}
      MAKE_VIDEO_SCRIPT: ${{ steps.params.outputs.MAKE_VIDEO_SCRIPT }}

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed asset types
        id: changed
        uses: dorny/paths-filter@v3
        with:
          filters: |
            mp4:
              - 'assets/*.mp4'
            jpeg:
              - 'assets/*.jpeg'
            wav:
              - 'assets/*.wav'

      - name: âœ… Check actor/commit + set params from file type
        id: params
        shell: bash
        run: |
          # defaults
          echo "should_run=false" >> "$GITHUB_OUTPUT"
          echo "duration=" >> "$GITHUB_OUTPUT"
          echo "MAKE_VIDEO_SCRIPT=" >> "$GITHUB_OUTPUT"
          echo "Actor: ${{ github.actor }}"
          echo "Repo owner: ${{ github.repository_owner }}"
          echo "Changed mp4:  ${{ steps.changed.outputs.mp4 }}"
          echo "Changed jpeg: ${{ steps.changed.outputs.jpeg }}"
          echo "Changed wav:  ${{ steps.changed.outputs.wav }}"

          # If multiple types change in one push, choose a priority order:
          # mp4 > jpeg > wav (change this if you want different precedence).
          if [[ "${{ steps.changed.outputs.mp4 }}" == "true" ]]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "duration=3600" >> "$GITHUB_OUTPUT"
            echo "MAKE_VIDEO_SCRIPT=make_video_play" >> "$GITHUB_OUTPUT"

          elif [[ "${{ steps.changed.outputs.jpeg }}" == "true" ]]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "duration=14400" >> "$GITHUB_OUTPUT"
            echo "MAKE_VIDEO_SCRIPT=make_video" >> "$GITHUB_OUTPUT"

          elif [[ "${{ steps.changed.outputs.wav }}" == "true" ]]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "duration=14400" >> "$GITHUB_OUTPUT"
            echo "MAKE_VIDEO_SCRIPT=make_video_play" >> "$GITHUB_OUTPUT"
          fi

  build-video:
    needs: check-conditions
    if: needs.check-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: âš™ï¸ Set up FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: ðŸ› ï¸ Run Bash video script
        run: bash scripts/${{ needs.check-conditions.outputs.MAKE_VIDEO_SCRIPT }}.sh "${{ needs.check-conditions.outputs.duration }}"

      - name: ðŸ“¦ Upload final video as artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-relaxing-video-${{ github.run_id }}-${{ github.sha }}
          path: "*.mp4"

      - name: Write run ID to repo
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
          RUN_ID: ${{ github.run_id }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git clone https://x-access-token:${GH_TOKEN}@github.com/rajjobuddy/rmb.git
          cd rmb

          echo "Run ID: ${RUN_ID}" >> input-trigger.txt

          git add input-trigger.txt
          git commit -m "Update input-trigger.txt with run ID ${RUN_ID}"
          git push
